<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.nike.geo.model.ApprovalDaoImpl">

	<!-- 북마크 -->
	<select id="selectFavList" resultType="Ap_FavVo">
		SELECT APF_ID, EMP_NO, APD_FORM, 
			   APF_NAME
		 FROM AP_FAV
		 WHERE EMP_NO =  #{empNo}
	</select>
	
	<!-- 북마크 등록 -->
	<insert id="addFav">
		<selectKey keyProperty="name" resultType="java.lang.String" order="BEFORE">
			SELECT  CODE_NAME 
                 FROM COM c 
                 WHERE COMMON_CODE =#{apd_form}
		</selectKey>
	
		 INSERT INTO AP_FAV (APF_ID, EMP_NO, APD_FORM,
	                         REG_ID, REG_DATE, MOD_ID, 
	                         MOD_DATE,APF_NAME )
        			VALUES (FAV_SEQ.NEXTVAL, #{emp_no}, #{apd_form}, 
           					#{emp_no}, SYSDATE, #{emp_no}, 
           					SYSDATE, #{name}
    						)
	</insert>
	
	<!-- 북마크 삭제 -->
	<delete id="delFav">
		DELETE FROM AP_FAV
		 WHERE EMP_NO = #{emp_no}
		 AND APD_FORM=#{apd_form}
	</delete>
	
	
	
	
	<!--///////////////////////////////////////////////////////  -->
	<!-- 상신하기 -->
	
	<!-- 임시저장 -->
	<insert id="submit2"> 
		INSERT INTO AP_DOCU
				(APD_NO, EMP_NO, APD_CON, 
				APD_STEP, APD_STATUS, APD_DAYS, 
				APD_HALF_YN,APD_FORM, APD_CLEAR_DATE, APD_TEMP_YN, 
				REG_ID, REG_DATE, MOD_ID, MOD_DATE)
		VALUES(Apd_docu_seq.NEXTVAL, #{emp_no}, #{apd_con}, 
				#{apd_step}, 'W', #{apd_days},
				#{apd_half_yn},	#{apd_form}, SYSDATE,
				<choose>
					<when test='type == "상신하기"'>
						'N'
					</when>
					<otherwise>
						'Y'
					</otherwise>
				</choose> 
				 
				,#{emp_no},SYSDATE, #{emp_no}, SYSDATE)    
	</insert>
	

	
	<!-- 결재라인 : 직급 순서 받아오기 -->
	<select id="selectPos" resultType="java.lang.Integer" >
	SELECT c."REF"
		FROM COM c
		JOIN EMP e ON c.COMMON_CODE = e.EMP_POS
		WHERE e.EMP_NO = #{emp_no}
	</select>
	
	<!-- 결재라인 : 서류 번호 받아오기 -->
	<select id="selctAPD" resultType="java.lang.Integer">
		SELECT MAX(APD_NO)
 			FROM AP_DOCU
	</select>
	
	<!--결재라인 추가  -->
	<insert id="putLine">
		INSERT INTO GEO.AP_LINE
			(APL_NO, APD_NO, EMP_NO, 
			APL_ORDER, APL_DATE,
			REG_ID, REG_DATE, MOD_ID, MOD_DATE)
		VALUES(APLINE_SEQ.NEXTVAL, #{apd_no}, #{emp_no}, 
				#{apl_order}, SYSDATE, 
				#{emp_no}, SYSDATE, #{emp_no}, SYSDATE)
	</insert>	
	
	
	<!-- 참조라인 추가 -->
	<insert id="putRef">
		INSERT INTO AP_RF
				(APR_NO, APD_NO, APR_REF, 
				REG_ID, REG_DATE, MOD_ID, MOD_DATE)
			VALUES(APREF_SEQ.NEXTVAL, #{apd_no}, #{apr_ref}, 
					#{emp_no}, SYSDATE, #{emp_no}, SYSDATE)
	</insert>
	
	<!--  -->
	<!-- 파일 -->
	<!--결재 파일 추가  -->
	<insert id="putFile">
		INSERT INTO GEO."FILE" (FILE_NO, ORIGIN_NO, FILE_ONAME,
								FILE_SNAME, FILE_SIZE, FILE_TYPE,
								FILE_RANK, FILE_DEL_YN, REG_ID,
								REG_DATE, MOD_ID, MOD_DATE)
			VALUES(FILE_SEQ.NEXTVAL, #{origin_no}, #{file_oname},
					#{file_sname}, #{file_size}, '1',
					'0', 'N', #{reg_id},
					SYSDATE, #{reg_id}, SYSDATE)
	</insert>
	
	
	
	<!-- ///////////////////////////////////////////// -->
	<!-- 문서함 -->
	<!-- 결재문서함 목록 조회 -->
	<!-- 대기.반려.철회 상관없이 모든 거 다 나오게 -->
	<select id="selectApproval" resultType="Ap_DocuVo">
	SELECT APD_NO,EMP_NO , SUBSTR(APD_CON, 1, 10) AS APD_CON,
				APD_STEP ,APD_STATUS ,APD_DAYS ,
				APD_HALF_YN ,APD_FORM ,APD_CLEAR_DATE ,APD_TEMP_YN ,
				REG_ID ,REG_DATE ,MOD_ID ,MOD_DATE 
 		FROM AP_DOCU ad 
 		WHERE APD_NO IN (SELECT APD_NO 
					 FROM AP_LINE al 
					 WHERE EMP_NO = #{emp_no})
 		AND APD_TEMP_YN = 'N'
	</select>
	
	
	<!-- //////////////////////////////////////////////////////////////// -->
	<!-- 상세조회 -->
	<!-- 문서번호로 상세 조회 -->
	<select id="selectDeatil" resultType="Ap_DocuVo">
		SELECT APD_NO,EMP_NO ,APD_CON ,
				APD_STEP ,APD_STATUS ,APD_DAYS ,
				APD_HALF_YN ,APD_FORM ,APD_CLEAR_DATE ,APD_TEMP_YN ,
				REG_ID ,REG_DATE ,MOD_ID ,MOD_DATE 
 		FROM AP_DOCU ad 
 		WHERE APD_NO = #{apd_no}
	</select>
	
	<!-- 결재자 순서대로 조회 -->
	<select id="selectLine" resultType="Ap_LineVo">
				SELECT al.APL_NO,al.APD_NO,al.EMP_NO,
				al.APL_ORDER,TO_CHAR(NVL(al.APL_DATE, SYSDATE), 'YY-MM-DD HH24:MI') AS APL_DATE,
				al.APL_STATUS,al.APL_MSG,
				al.REG_ID,TO_CHAR(al.REG_DATE, 'YY-MM-DD HH24:MI') AS REG_DATE,
				al.MOD_ID,TO_CHAR(al.MOD_DATE, 'YY-MM-DD HH24:MI') AS MOD_DATE,
				al.FILE_ONAME,e.EMP_NAME 
		  FROM AP_LINE al
		  INNER JOIN EMP e 
		  ON al.EMP_NO = e.EMP_NO 
		  WHERE APD_NO = #{apd_no}
		  ORDER BY APL_ORDER
	</select>
	
	<!-- 반려메시지 조회 -->
	<select id="sel_Msg" resultType="java.lang.String">
		SELECT APL_MSG 
		 FROM AP_LINE al
		 WHERE APD_NO = #{apd_no}
	</select>
	
<!-- 	첨부파일 조회 -->
	<select id="selectFile" resultType="FileVo">
		SELECT *
		 FROM "FILE" f 
		 WHERE ORIGIN_NO = #{apd_no}
	</select>
	
	
	<!-- 반려하기 -->
	<!-- 결재번호 조회 -->
	<select id="selectAPL_NO" resultType="java.lang.Integer">
		SELECT APL_NO 
		 FROM AP_LINE al
		 WHERE al.APD_NO = #{apd_no}
		 AND EMP_NO =#{emp_no}
	</select>
	
	<!-- 결재라인 수정 -->
	<update id="updateReturn">
		UPDATE AP_LINE 
			SET APL_DATE=SYSDATE, APL_STATUS=2, APL_MSG=#{apl_msg}, MOD_ID=#{emp_no}, MOD_DATE=SYSDATE
			WHERE APL_NO=#{apl_no}
	</update>
	
	<!-- 서류 상태 수정 -->
	<update id="update_aStatus">
		UPDATE  AP_DOCU SET APD_STATUS =#{apd_status} WHERE APD_NO =#{apd_no}
	</update>
	

	
</mapper>



















